---
# This CI will only work for trusted contributors. CI for public contributors
# runs via a webhook on the merge requests. There's nothing you have to do if
# you want your changes tested -- created pipelines will be automatically
# linked in the merge request and appropriate labels will be added to it.
# Changes to this file will NOT be reflected in the testing.

include:
  - project: cki-project/pipeline-definition
    ref: main
    file: kernel_templates.yml

workflow: !reference [.workflow]

# Basic bridge job
.trigger:
  trigger:
    branch: rhel7
  variables:
    kernel_type: internal
    make_target: rpm
    builder_image: quay.io/cki/builder-rhel7
    build_kabi_stablelist: 'true'
    tree_yaml_name: rhel
    publish_elsewhere: 'true'
    name: kernel-rhel7
    architectures: 'x86_64 ppc64le ppc64 s390x'
    kpet_tree_family: rhel7

# Realtime specific configuration
.realtime_check:
  # best-effort, shouldn't block MRs
  allow_failure: true
  trigger:
    branch: rhel7-rt
  variables:
    # adjust configuration above slightly for -rt
    name: kernel-rt-rhel7
    package_name: kernel-rt
    merge_tree: ${CI_MERGE_REQUEST_PROJECT_URL}.git
    merge_branch: main-rt
    srpm_make_target: 'rt-srpm'
    # realtime is x86-only
    architectures: 'x86_64'
    # no testing
    skip_test: 'true'
    skip_results: 'true'

# regular pipelines

merge_request_regular:
  extends: [.internal, .merge_request, .with_notifications,
            .trigger]

realtime_check_regular:
  extends: [.internal, .merge_request,
            .trigger, .realtime_check]

baseline_regular:
  extends: [.internal, .baseline, .with_notifications,
            .trigger]

# private pipelines

merge_request_private:
  extends: [.scratch, .merge_request,
            .trigger]

realtime_check_private:
  extends: [.scratch, .merge_request,
            .trigger, .realtime_check]

# no private baselines as repos are mirrored
